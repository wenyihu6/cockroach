# Regression test for candidatesToRemove() bug where it incorrectly accessed
# nonVoterIndex instead of voterIndex when iterating through voters with no
# constraints.
#
# Bug: When there are extra voters and no constraints, the code comment said
# "No constraints. Can remove any voter." but the code was incorrectly
# appending from rac.replicas[nonVoterIndex][i].StoreID instead of
# rac.replicas[voterIndex][i].StoreID.

store 
  store-id=2 attrs=ssd locality-tiers=region=b,zone=b1 node-id=1
----

store 
  store-id=3 attrs=disk locality-tiers=region=b,zone=b1 node-id=1
----

store 
  store-id=5 attrs=ssd locality-tiers=region=d,zone=d2 node-id=2
  store-id=6 attrs=disk locality-tiers=region=a,zone=a1 node-id=3
  store-id=7 attrs=disk locality-tiers=region=a,zone=a1 node-id=4
----

store 
  store-id=8 attrs=tape locality-tiers=region=d,zone=d2 node-id=5
----

span-config name=no-constraint-extra-voters num-replicas=5 num-voters=3
----
 num-replicas=5 num-voters=3
 constraints:
   :5

# Test scenario: 4 voters (2, 3, 5, 8) when only 3 are needed, with 2 non-voters
# (6, 7) and no constraints. The toRemove function should return all 4 voters as
# candidates since any can be removed.
analyze-constraints config-name=no-constraint-extra-voters leaseholder=3
store-id=2 type=VOTER_FULL   
store-id=3 type=VOTER_FULL
store-id=5 type=VOTER_FULL
store-id=8 type=VOTER_FULL  
store-id=6 type=NON_VOTER 
store-id=7 type=NON_VOTER 
----
needed: voters 3 non-voters 2
voters: 2(=b,=b1,=1) 3(=b,=b1,=1) 5(=d,=d2,=2) 8(=d,=d2,=5)
non-voters: 6(=a,=a1,=3) 7(=a,=a1,=4)
constraints:
  :5
    voters: 2 3 5 8
    non-voters: 6 7
leaseholder pref-index s3:0
lease pref-indices: s2:0 s3:0 s5:0 s8:0
diversity: voter 0.722222, all 0.844444

candidates
----
nonVoterToVoter
	err: expected enough=false voters but have 4/3
addingVoter
	err: expected enough=false voters but have 4/3
voterToNonVoter
	err: expected enough=false non-voters but have 2/2
addingNonVoter
	err: expected enough=false non-voters but have 2/2
roleSwap
toRemove
	remove: 2 3 5 8
voterUnsatisfied
nonVoterUnsatisfied
replaceVoterRebalance replace=2
	err: expected only matched constraints but found under=0 match=0 over=1
replaceVoterRebalance replace=3
	err: expected only matched constraints but found under=0 match=0 over=1
replaceVoterRebalance replace=5
	err: expected only matched constraints but found under=0 match=0 over=1
replaceVoterRebalance replace=8
	err: expected only matched constraints but found under=0 match=0 over=1
replaceNonVoterRebalance replace=6
	err: expected only matched constraints but found under=0 match=0 over=1
replaceNonVoterRebalance replace=7
	err: expected only matched constraints but found under=0 match=0 over=1
toMoveLease
  leaseholder-pref-index: 0 cands: s2:0 s5:0 s8:0

