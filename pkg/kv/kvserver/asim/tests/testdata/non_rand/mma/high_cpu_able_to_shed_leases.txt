# See comments on top of high_cpu_able_to_shed_leases.txt for test details.

# Case (2) where s1 has leases and is CPU overloaded due to raft CPU. It
# will be able to shed its own leases because it is the leaseholer. There should
# be a period of lease-rebalancing activity before replica-rebalancing.

gen_cluster nodes=5 node_cpu_rate_capacity=9000000000
----

setting split_queue_enabled=false
----

gen_ranges ranges=25 min_key=0 max_key=10000 placement_type=replica_placement
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6
----
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6

gen_load rate=50000 rw_ratio=0 min_key=0 max_key=10000 raft_cpu_per_write=100000
----
5.00 raft-vcpus, 49 KiB/s goodput

eval duration=5m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=5000234417, s2=2600729899, s3=2600225840, s4=2400008576, s5=2399504517] (stddev=1004067542.61, mean=3000140649.80, sum=15000703249)
cpu#1: thrash_pct: [s1=167%, s2=102%, s3=94%, s4=86%, s5=85%]  (sum=533%)
cpu_util#1: last:  [s1=0.56, s2=0.29, s3=0.29, s4=0.27, s5=0.27] (stddev=0.11, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=167%, s2=102%, s3=94%, s4=86%, s5=85%]  (sum=533%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=0, s2=6, s3=3, s4=7, s5=9] (stddev=3.16, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=50002, s2=26007, s3=26002, s4=24000, s5=23995] (stddev=10040.60, mean=30001.20, sum=150006)
write_bytes_per_second#1: thrash_pct: [s1=167%, s2=102%, s3=94%, s4=86%, s5=85%]  (sum=533%)
artifacts[mma-only]: addc6427697d74df
==========================
cpu#1: last:  [s1=3200050173, s2=2799931539, s3=3199069848, s4=2599387069, s5=3199932923] (stddev=253037400.00, mean=2999674310.40, sum=14998371552)
cpu#1: thrash_pct: [s1=133%, s2=69%, s3=39%, s4=100%, s5=71%]  (sum=412%)
cpu_util#1: last:  [s1=0.36, s2=0.31, s3=0.36, s4=0.29, s5=0.36] (stddev=0.03, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=133%, s2=69%, s3=39%, s4=100%, s5=71%]  (sum=412%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=6, s2=2, s3=5, s4=4, s5=8] (stddev=2.00, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=16, s2=14, s3=16, s4=13, s5=16] (stddev=1.26, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=32000, s2=27999, s3=31990, s4=25993, s5=31999] (stddev=2530.46, mean=29996.20, sum=149981)
write_bytes_per_second#1: thrash_pct: [s1=133%, s2=69%, s3=39%, s4=100%, s5=71%]  (sum=412%)
artifacts[mma-count]: c8dfeaa99025121a
==========================
