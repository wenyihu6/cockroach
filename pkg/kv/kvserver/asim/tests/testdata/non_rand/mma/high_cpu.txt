# This test verifies that the allocator can rebalance replicas and leases when
# there is high cpu load imbalance across the cluster. The test sets up a 10-node
# cluster with two distinct workloads: one evenly distributed across all nodes,
# and another high-cpu workload initially concentrated on only the first few nodes
# due to skewed placement. The second workload has significantly higher cpu cost
# per op, creating cpu imbalance.
#
# Expected outcome: The allocator should rebalance both replicas and leases to
# distribute the high-cpu workload more evenly across all 10 nodes.
gen_cluster nodes=10 node_cpu_rate_capacity=8000000000
----

# TODO(wenyihu6): why didn't we balance more replicas/leases - is it because of a very high cpu per range 

# Disable the split queue to keep the number of ranges constant.
setting split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=100 min_key=0 max_key=10000
----

# Evenly distributed workload.
gen_load rate=500000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=10000 raft_cpu_per_write=2000 min_key=0 max_key=10000
----
5.00 access-vcpus, 0.05 raft-vcpus, 2.4 MiB/s goodput

# Another workload is added over the second half of the keyspace, which is initially
# mostly on s1-s3.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=10000000 rw_ratio=0.99 min_block=128 max_block=128 request_cpu_per_access=1000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
10.00 access-vcpus, 2.00 raft-vcpus, 12 MiB/s goodput

eval duration=2m samples=1 seed=42 cfgs=(mma-only) metrics=(cpu,cpu_util,replicas,leases)
----
cpu#1: last:  [s1=7113481763, s2=3924885327, s3=2144677594, s4=1884761933, s5=1294936390, s6=1014934498, s7=714652394, s8=1075377448, s9=905209934, s10=1074683503] (stddev=1891683956.23, mean=2114760078.40, sum=21147600784)
cpu#1: thrash_pct: [s1=7%, s2=3%, s3=10%, s4=2%, s5=2%, s6=0%, s7=1%, s8=0%, s9=1%, s10=2%]  (sum=28%)
cpu_util#1: last:  [s1=0.89, s2=0.49, s3=0.27, s4=0.24, s5=0.16, s6=0.13, s7=0.09, s8=0.13, s9=0.11, s10=0.13] (stddev=0.24, mean=0.26, sum=3)
cpu_util#1: thrash_pct: [s1=7%, s2=3%, s3=10%, s4=2%, s5=2%, s6=0%, s7=1%, s8=0%, s9=1%, s10=2%]  (sum=28%)
leases#1: first: [s1=37, s2=22, s3=14, s4=13, s5=11, s6=11, s7=10, s8=11, s9=10, s10=11] (stddev=8.07, mean=15.00, sum=150)
leases#1: last:  [s1=33, s2=14, s3=17, s4=15, s5=14, s6=13, s7=10, s8=12, s9=10, s10=12] (stddev=6.34, mean=15.00, sum=150)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=9%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%]  (sum=9%)
replicas#1: first: [s1=80, s2=70, s3=51, s4=42, s5=37, s6=35, s7=34, s8=33, s9=34, s10=34] (stddev=16.02, mean=45.00, sum=450)
replicas#1: last:  [s1=80, s2=69, s3=47, s4=43, s5=37, s6=35, s7=35, s8=34, s9=36, s10=34] (stddev=15.48, mean=45.00, sum=450)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%]  (sum=0%)
artifacts[mma-only]: e2ed66af87b5617b
==========================
