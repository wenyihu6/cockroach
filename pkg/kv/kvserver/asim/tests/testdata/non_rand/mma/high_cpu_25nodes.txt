# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

# TODO(tbg): likely accidentally too low.
gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----
0.00 access-vcpus, 0.00 raft-vcpus, 73 KiB/s goodput

# Another workload is added over the second half of the keyspace, which is initially
# only mainly on s1-s3 due to the skewed distribution.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=7000000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
105.00 access-vcpus, 0.02 raft-vcpus, 750 B/s goodput

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=4202112278, s2=4195643263, s3=4200303189, s4=4206731135, s5=4205557261, s6=4208976488, s7=4187013797, s8=4207042333, s9=6311701481, s10=4189528184, s11=4204247662, s12=4209947857, s13=4206441311, s14=4197389269, s15=4194519048, s16=4203635911, s17=4202237293, s18=4198202573, s19=4203291209, s20=4201020781, s21=4198203410, s22=4196226688, s23=4196892028, s24=2104880599, s25=4214392060] (stddev=594968719.81, mean=4201845484.32, sum=105046137108)
cpu#1: thrash_pct: [s1=4%, s2=4%, s3=18%, s4=3%, s5=3%, s6=12%, s7=2%, s8=2%, s9=4%, s10=2%, s11=2%, s12=2%, s13=2%, s14=2%, s15=3%, s16=2%, s17=11%, s18=2%, s19=2%, s20=2%, s21=2%, s22=20%, s23=3%, s24=2%, s25=11%]  (sum=124%)
cpu_util#1: last:  [s1=0.53, s2=0.52, s3=0.53, s4=0.53, s5=0.53, s6=0.53, s7=0.52, s8=0.53, s9=0.79, s10=0.52, s11=0.53, s12=0.53, s13=0.53, s14=0.52, s15=0.52, s16=0.53, s17=0.53, s18=0.52, s19=0.53, s20=0.53, s21=0.52, s22=0.52, s23=0.52, s24=0.26, s25=0.53] (stddev=0.07, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=4%, s2=4%, s3=18%, s4=3%, s5=3%, s6=12%, s7=2%, s8=2%, s9=4%, s10=2%, s11=2%, s12=2%, s13=2%, s14=2%, s15=3%, s16=2%, s17=11%, s18=2%, s19=2%, s20=2%, s21=2%, s22=20%, s23=3%, s24=2%, s25=11%]  (sum=124%)
leases#1: first: [s1=29, s2=13, s3=4, s4=2, s5=2, s6=2, s7=3, s8=3, s9=2, s10=3, s11=4, s12=1, s13=2, s14=2, s15=4, s16=3, s17=3, s18=3, s19=2, s20=3, s21=3, s22=2, s23=2, s24=1, s25=2] (stddev=5.56, mean=4.00, sum=100)
leases#1: last:  [s1=2, s2=2, s3=2, s4=3, s5=4, s6=4, s7=5, s8=4, s9=5, s10=4, s11=5, s12=3, s13=4, s14=6, s15=5, s16=4, s17=5, s18=6, s19=4, s20=4, s21=5, s22=4, s23=4, s24=2, s25=4] (stddev=1.13, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=15%, s4=0%, s5=0%, s6=8%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=8%, s18=0%, s19=0%, s20=0%, s21=0%, s22=15%, s23=0%, s24=0%, s25=8%]  (sum=55%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=11, s6=9, s7=8, s8=8, s9=7, s10=8, s11=7, s12=7, s13=7, s14=7, s15=7, s16=7, s17=7, s18=7, s19=7, s20=8, s21=8, s22=7, s23=8, s24=7, s25=7] (stddev=11.96, mean=12.00, sum=300)
replicas#1: last:  [s1=13, s2=11, s3=13, s4=11, s5=13, s6=13, s7=13, s8=13, s9=12, s10=12, s11=11, s12=13, s13=11, s14=14, s15=11, s16=12, s17=10, s18=12, s19=12, s20=12, s21=12, s22=11, s23=12, s24=12, s25=11] (stddev=0.94, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=5%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=5%, s18=0%, s19=0%, s20=0%, s21=0%, s22=5%, s23=0%, s24=0%, s25=0%]  (sum=14%)
write_bytes_per_second#1: last:  [s1=194, s2=164, s3=194, s4=1653, s5=10550, s6=10589, s7=12052, s8=9112, s9=10578, s10=10615, s11=10513, s12=10564, s13=11997, s14=15045, s15=12080, s16=12096, s17=10577, s18=12045, s19=9072, s20=9094, s21=10586, s22=10572, s23=9114, s24=9081, s25=9099] (stddev=3961.91, mean=9089.44, sum=227236)
write_bytes_per_second#1: thrash_pct: [s1=10%, s2=13%, s3=35%, s4=17%, s5=41%, s6=64%, s7=41%, s8=32%, s9=66%, s10=38%, s11=36%, s12=38%, s13=86%, s14=55%, s15=39%, s16=45%, s17=56%, s18=42%, s19=60%, s20=38%, s21=62%, s22=38%, s23=37%, s24=57%, s25=37%]  (sum=1082%)
artifacts[mma-count]: 8bd4d31af50e623a
==========================
