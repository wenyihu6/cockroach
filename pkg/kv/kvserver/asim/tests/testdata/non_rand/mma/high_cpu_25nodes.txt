# This test verifies that the allocator can rebalance replicas and leases when
# there is high CPU load imbalance across a large cluster. The test set-up is
# similar to high_cpu.txt but is on 25 nodes and with 3x the load for two
# gen_load commands.
gen_cluster nodes=25 node_cpu_rate_capacity=8000000000
----

setting split_queue_enabled=false
----

# This workload will be initially evenly distributed over the cluster.
gen_ranges ranges=50 min_key=0 max_key=10000
----

# TODO(tbg): likely accidentally too low.
gen_load rate=15000 rw_ratio=0.95 min_block=100 max_block=100 request_cpu_per_access=100 raft_cpu_per_write=20 min_key=0 max_key=10000
----
0.00 access-vcpus, 0.00 raft-vcpus, 73 KiB/s goodput

# Another workload is added over the second half of the keyspace, which is initially
# only mainly on s1-s3 due to the skewed distribution.
gen_ranges ranges=50 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=15000 rw_ratio=0.95 min_block=1 max_block=1 request_cpu_per_access=7000000 raft_cpu_per_write=20000 min_key=10001 max_key=20000
----
105.00 access-vcpus, 0.02 raft-vcpus, 750 B/s goodput

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=16788943455, s2=10476043056, s3=6300364294, s4=8401802303, s5=6302904050, s6=4197980064, s7=4225862293, s8=2106492429, s9=4210830061, s10=2087841743, s11=4218812292, s12=2091860770, s13=4204798018, s14=2102861158, s15=2105158712, s16=2092616855, s17=4205295508, s18=4212785633, s19=365351, s20=2106100143, s21=4194174951, s22=2108690099, s23=2113072783, s24=688770, s25=4199113950] (stddev=3459829011.72, mean=4202218349.64, sum=105055458741)
cpu#1: thrash_pct: [s1=7%, s2=32%, s3=44%, s4=21%, s5=12%, s6=3%, s7=3%, s8=1%, s9=3%, s10=1%, s11=11%, s12=2%, s13=3%, s14=1%, s15=2%, s16=2%, s17=11%, s18=3%, s19=0%, s20=2%, s21=11%, s22=2%, s23=1%, s24=0%, s25=11%]  (sum=191%)
cpu_util#1: last:  [s1=2.10, s2=1.31, s3=0.79, s4=1.05, s5=0.79, s6=0.52, s7=0.53, s8=0.26, s9=0.53, s10=0.26, s11=0.53, s12=0.26, s13=0.53, s14=0.26, s15=0.26, s16=0.26, s17=0.53, s18=0.53, s19=0.00, s20=0.26, s21=0.52, s22=0.26, s23=0.26, s24=0.00, s25=0.52] (stddev=0.43, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=7%, s2=32%, s3=44%, s4=21%, s5=12%, s6=3%, s7=3%, s8=1%, s9=3%, s10=1%, s11=11%, s12=2%, s13=3%, s14=1%, s15=2%, s16=2%, s17=11%, s18=3%, s19=0%, s20=2%, s21=11%, s22=2%, s23=1%, s24=0%, s25=11%]  (sum=191%)
leases#1: first: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
leases#1: last:  [s1=9, s2=7, s3=5, s4=6, s5=5, s6=4, s7=4, s8=2, s9=4, s10=3, s11=5, s12=2, s13=5, s14=3, s15=3, s16=3, s17=4, s18=4, s19=2, s20=3, s21=4, s22=3, s23=4, s24=3, s25=3] (stddev=1.57, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=25%, s3=38%, s4=16%, s5=8%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=8%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=8%, s18=0%, s19=0%, s20=0%, s21=8%, s22=0%, s23=0%, s24=0%, s25=8%]  (sum=121%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
replicas#1: last:  [s1=56, s2=38, s3=20, s4=15, s5=11, s6=9, s7=9, s8=7, s9=9, s10=8, s11=8, s12=7, s13=9, s14=8, s15=8, s16=8, s17=8, s18=8, s19=7, s20=8, s21=8, s22=7, s23=8, s24=8, s25=8] (stddev=10.98, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=4%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=4%, s12=0%, s13=0%, s14=0%, s15=0%, s16=0%, s17=4%, s18=0%, s19=0%, s20=0%, s21=4%, s22=0%, s23=0%, s24=0%, s25=4%]  (sum=22%)
write_bytes_per_second#1: last:  [s1=9764, s2=9488, s3=9236, s4=9176, s5=9084, s6=9044, s7=9085, s8=9059, s9=9085, s10=9077, s11=9019, s12=9030, s13=9036, s14=9063, s15=9053, s16=9039, s17=9091, s18=9006, s19=9074, s20=9051, s21=9082, s22=9035, s23=9123, s24=9009, s25=9030] (stddev=163.74, mean=9113.56, sum=227839)
write_bytes_per_second#1: thrash_pct: [s1=463%, s2=450%, s3=380%, s4=388%, s5=404%, s6=384%, s7=389%, s8=397%, s9=355%, s10=368%, s11=413%, s12=412%, s13=398%, s14=386%, s15=368%, s16=393%, s17=392%, s18=434%, s19=404%, s20=408%, s21=376%, s22=384%, s23=428%, s24=388%, s25=379%]  (sum=9940%)
artifacts[mma-only]: 72871c6fd7d83892
==========================
cpu#1: last:  [s1=4195103021, s2=4193532795, s3=4205832094, s4=4226068910, s5=4195485113, s6=2091012083, s7=4197642766, s8=2107689754, s9=4203147366, s10=4206685747, s11=4211211098, s12=4198129407, s13=6290289414, s14=4207261981, s15=4200169512, s16=4200099194, s17=4204802777, s18=4196373796, s19=4198140856, s20=4188081570, s21=6320133062, s22=4207212810, s23=4221716189, s24=4196486483, s25=4204112555] (stddev=841224495.12, mean=4202656814.12, sum=105066420353)
cpu#1: thrash_pct: [s1=6%, s2=15%, s3=19%, s4=12%, s5=3%, s6=11%, s7=3%, s8=1%, s9=3%, s10=3%, s11=3%, s12=3%, s13=30%, s14=11%, s15=11%, s16=12%, s17=3%, s18=3%, s19=4%, s20=3%, s21=13%, s22=28%, s23=3%, s24=3%, s25=20%]  (sum=228%)
cpu_util#1: last:  [s1=0.52, s2=0.52, s3=0.53, s4=0.53, s5=0.52, s6=0.26, s7=0.52, s8=0.26, s9=0.53, s10=0.53, s11=0.53, s12=0.52, s13=0.79, s14=0.53, s15=0.53, s16=0.53, s17=0.53, s18=0.52, s19=0.52, s20=0.52, s21=0.79, s22=0.53, s23=0.53, s24=0.52, s25=0.53] (stddev=0.11, mean=0.53, sum=13)
cpu_util#1: thrash_pct: [s1=6%, s2=15%, s3=19%, s4=12%, s5=3%, s6=11%, s7=3%, s8=1%, s9=3%, s10=3%, s11=3%, s12=3%, s13=30%, s14=11%, s15=11%, s16=12%, s17=3%, s18=3%, s19=4%, s20=3%, s21=13%, s22=28%, s23=3%, s24=3%, s25=20%]  (sum=228%)
leases#1: first: [s1=28, s2=14, s3=4, s4=3, s5=3, s6=2, s7=2, s8=2, s9=2, s10=2, s11=3, s12=2, s13=3, s14=3, s15=2, s16=3, s17=3, s18=3, s19=2, s20=2, s21=2, s22=3, s23=3, s24=3, s25=1] (stddev=5.43, mean=4.00, sum=100)
leases#1: last:  [s1=2, s2=2, s3=2, s4=4, s5=4, s6=3, s7=5, s8=2, s9=4, s10=4, s11=5, s12=4, s13=7, s14=3, s15=4, s16=4, s17=4, s18=5, s19=4, s20=6, s21=5, s22=4, s23=5, s24=5, s25=3] (stddev=1.23, mean=4.00, sum=100)
leases#1: thrash_pct: [s1=0%, s2=10%, s3=16%, s4=8%, s5=0%, s6=8%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=24%, s14=15%, s15=8%, s16=8%, s17=0%, s18=0%, s19=0%, s20=0%, s21=9%, s22=23%, s23=0%, s24=0%, s25=16%]  (sum=144%)
replicas#1: first: [s1=56, s2=44, s3=25, s4=16, s5=12, s6=9, s7=8, s8=7, s9=7, s10=7, s11=7, s12=7, s13=7, s14=8, s15=7, s16=8, s17=7, s18=8, s19=7, s20=7, s21=7, s22=7, s23=7, s24=8, s25=7] (stddev=11.97, mean=12.00, sum=300)
replicas#1: last:  [s1=12, s2=12, s3=13, s4=12, s5=12, s6=12, s7=11, s8=12, s9=13, s10=12, s11=12, s12=11, s13=13, s14=12, s15=11, s16=12, s17=11, s18=13, s19=13, s20=13, s21=10, s22=11, s23=12, s24=14, s25=11] (stddev=0.89, mean=12.00, sum=300)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=4%, s6=5%, s7=0%, s8=0%, s9=0%, s10=0%, s11=0%, s12=0%, s13=9%, s14=5%, s15=0%, s16=0%, s17=0%, s18=0%, s19=0%, s20=0%, s21=5%, s22=0%, s23=0%, s24=0%, s25=5%]  (sum=33%)
write_bytes_per_second#1: last:  [s1=179, s2=181, s3=195, s4=3170, s5=7603, s6=9089, s7=12107, s8=10565, s9=12145, s10=10629, s11=10554, s12=10593, s13=10532, s14=7629, s15=10580, s16=10592, s17=13600, s18=10548, s19=10645, s20=15020, s21=9112, s22=9095, s23=12106, s24=12096, s25=9071] (stddev=3946.66, mean=9105.44, sum=227636)
write_bytes_per_second#1: thrash_pct: [s1=11%, s2=20%, s3=49%, s4=33%, s5=49%, s6=44%, s7=60%, s8=87%, s9=48%, s10=76%, s11=53%, s12=53%, s13=66%, s14=67%, s15=43%, s16=51%, s17=83%, s18=106%, s19=48%, s20=65%, s21=43%, s22=45%, s23=93%, s24=81%, s25=69%]  (sum=1442%)
artifacts[mma-count]: 4b5c45590666f377
==========================
