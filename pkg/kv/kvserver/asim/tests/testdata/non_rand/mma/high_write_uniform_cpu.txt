# This test sets up a 10-node cluster with two workloads: (read-only, high-cpu on lh)
# uniformly across nodes and (write-only, high-write) initially concentrated on s1-s3.
#
# Expected outcome: mma should rebalance replicas and leases to distribute the
# cpu load and write load more evenly across all stores.
gen_cluster nodes=10 node_cpu_rate_capacity=3000000000
----

# Read only workload, which generates 1000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1.0 request_cpu_per_access=5000000 min_key=1 max_key=10000
----
5.00 access-vcpus

# Write only workload, which generates no CPU and 20000op/s*1000B/op =
# 20000000B/s (x 3 replication factor) write bytes per second over the second half
# of the keyspace, which are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----
19 MiB/s goodput

setting split_queue_enabled=false
----

eval duration=20m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(disk_fraction_used,cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=502241666, s2=495158333, s3=499791666, s4=497383333, s5=499658333, s6=498491666, s7=496825000, s8=509516666, s9=500475000, s10=500458333] (stddev=3726019.51, mean=499999999.60, sum=4999999996)
cpu#1: thrash_pct: [s1=619%, s2=632%, s3=622%, s4=648%, s5=601%, s6=648%, s7=585%, s8=636%, s9=672%, s10=598%]  (sum=6260%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.17, s10=0.17] (stddev=0.00, mean=0.17, sum=2)
cpu_util#1: thrash_pct: [s1=619%, s2=632%, s3=622%, s4=648%, s5=601%, s6=648%, s7=585%, s8=636%, s9=672%, s10=598%]  (sum=6260%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.02, s2=0.02, s3=0.02, s4=0.02, s5=0.02, s6=0.02, s7=0.02, s8=0.02, s9=0.02, s10=0.02] (stddev=0.00, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=93%, s2=94%, s3=78%, s4=47%, s5=32%, s6=38%, s7=35%, s8=0%, s9=67%, s10=27%]  (sum=511%)
leases#1: first: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
leases#1: last:  [s1=12, s2=5, s3=5, s4=4, s5=5, s6=3, s7=5, s8=6, s9=8, s10=7] (stddev=2.41, mean=6.00, sum=60)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=26%, s4=13%, s5=14%, s6=25%, s7=13%, s8=0%, s9=28%, s10=14%]  (sum=135%)
replicas#1: first: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
replicas#1: last:  [s1=18, s2=18, s3=18, s4=18, s5=18, s6=18, s7=18, s8=18, s9=18, s10=18] (stddev=0.00, mean=18.00, sum=180)
replicas#1: thrash_pct: [s1=0%, s2=18%, s3=46%, s4=37%, s5=24%, s6=24%, s7=24%, s8=0%, s9=46%, s10=24%]  (sum=244%)
write_bytes_per_second#1: last:  [s1=5984496, s2=5986705, s3=5991405, s4=5991306, s5=5990626, s6=6016737, s7=5997968, s8=6017923, s9=5995243, s10=6017946] (stddev=12630.67, mean=5999035.50, sum=59990355)
write_bytes_per_second#1: thrash_pct: [s1=52%, s2=58%, s3=91%, s4=103%, s5=56%, s6=56%, s7=63%, s8=42%, s9=56%, s10=49%]  (sum=627%)
artifacts[mma-only]: 9e059a41f35a17e6
==========================
cpu#1: last:  [s1=496059222, s2=503888587, s3=498696487, s4=497270599, s5=500081749, s6=496545556, s7=500079281, s8=504352313, s9=494906392, s10=499157920] (stddev=2988490.97, mean=499103810.60, sum=4991038106)
cpu#1: thrash_pct: [s1=400%, s2=460%, s3=168%, s4=409%, s5=342%, s6=350%, s7=343%, s8=292%, s9=303%, s10=286%]  (sum=3353%)
cpu_util#1: last:  [s1=0.17, s2=0.17, s3=0.17, s4=0.17, s5=0.17, s6=0.17, s7=0.17, s8=0.17, s9=0.16, s10=0.17] (stddev=0.00, mean=0.17, sum=2)
cpu_util#1: thrash_pct: [s1=400%, s2=460%, s3=168%, s4=409%, s5=342%, s6=350%, s7=343%, s8=292%, s9=303%, s10=286%]  (sum=3353%)
disk_fraction_used#1: first: [s1=0.00, s2=0.00, s3=0.00, s4=0.00, s5=0.00, s6=0.00, s7=0.00, s8=0.00, s9=0.00, s10=0.00] (stddev=0.00, mean=0.00, sum=0)
disk_fraction_used#1: last:  [s1=0.02, s2=0.02, s3=0.02, s4=0.01, s5=0.02, s6=0.02, s7=0.02, s8=0.02, s9=0.02, s10=0.02] (stddev=0.00, mean=0.02, sum=0)
disk_fraction_used#1: thrash_pct: [s1=158%, s2=129%, s3=105%, s4=183%, s5=214%, s6=166%, s7=143%, s8=53%, s9=274%, s10=128%]  (sum=1552%)
leases#1: first: [s1=19, s2=11, s3=6, s4=3, s5=3, s6=3, s7=4, s8=3, s9=4, s10=4] (stddev=4.92, mean=6.00, sum=60)
leases#1: last:  [s1=6, s2=8, s3=3, s4=5, s5=7, s6=5, s7=5, s8=8, s9=7, s10=6] (stddev=1.48, mean=6.00, sum=60)
leases#1: thrash_pct: [s1=164%, s2=156%, s3=38%, s4=143%, s5=86%, s6=108%, s7=119%, s8=63%, s9=168%, s10=108%]  (sum=1154%)
replicas#1: first: [s1=39, s2=33, s3=23, s4=16, s5=13, s6=12, s7=11, s8=11, s9=11, s10=11] (stddev=9.76, mean=18.00, sum=180)
replicas#1: last:  [s1=17, s2=19, s3=20, s4=17, s5=19, s6=17, s7=18, s8=18, s9=16, s10=19] (stddev=1.18, mean=18.00, sum=180)
replicas#1: thrash_pct: [s1=227%, s2=201%, s3=109%, s4=308%, s5=283%, s6=168%, s7=205%, s8=83%, s9=332%, s10=227%]  (sum=2141%)
write_bytes_per_second#1: last:  [s1=5985540, s2=5991588, s3=6663886, s4=5347737, s5=6009676, s6=5986187, s7=5993652, s8=6017091, s9=5997642, s10=5996363] (stddev=294464.90, mean=5998936.20, sum=59989362)
write_bytes_per_second#1: thrash_pct: [s1=298%, s2=241%, s3=272%, s4=253%, s5=259%, s6=227%, s7=189%, s8=135%, s9=298%, s10=180%]  (sum=2351%)
artifacts[mma-count]: 750ab96be7a1e92c
==========================
