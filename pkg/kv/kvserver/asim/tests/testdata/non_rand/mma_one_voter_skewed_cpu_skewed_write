skip_under_ci
----

# replication factor one, the first store gets all the reads (CPU usage), the second one gets writes.

gen_cluster nodes=2 node_cpu_rate_capacity=100000
----

gen_ranges ranges=10 repl_factor=1 min_key=1 max_key=10000 placement_type=replica_placement bytes=26843545
{s1}:1
----
{s1:*}:1

gen_ranges ranges=10 repl_factor=1 min_key=10001 max_key=20000 placement_type=replica_placement bytes=26843545
{s2}:1
----
{s2:*}:1

# read cpu load of 1000x100=10k, all hitting s1, which is then at 100% cpu.
gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates 20% cpu and 5mb of writes per second.
# over the second half of the keyspace.
gen_load rate=5000 rw_ratio=0 min_block=1000 max_block=1000 raft_cpu_per_write=1 min_key=10001 max_key=20000
----

setting rebalance_mode=2 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false rebalance_objective=1
----

eval duration=90m samples=1 seed=42
----
OK

plot stat=cpu sample=1
----
 55065 ┤ ╭─────────────────────────────────────────────────────────────────────────────
 51394 ┤ │─────────────────────────────────────────────────────────────────────────────
 47723 ┤╭│
 44052 ┤││
 40381 ┤││
 36710 ┤││
 33039 ┤╭╯
 29368 ┤│
 25697 ┤│
 22026 ┤│
 18355 ┤│
 14684 ┤│
 11013 ┤│
  7342 ┤│
  3671 ┤│
     0 ┼╯
                                              cpu
initial store values: [s1=0, s2=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=50034, s2=55009] (stddev=2487.50, mean=52521.50, sum=105043)

plot stat=write_bytes_per_second
----
 5001666 ┤╭──────────────────────────────────────────────────────────────────────────────
 4668222 ┤│
 4334777 ┤│
 4001333 ┤│
 3667888 ┤│
 3334444 ┤│
 3001000 ┤│
 2667555 ┤│
 2334111 ┤│
 2000666 ┤│
 1667222 ┤│
 1333778 ┤│
 1000333 ┤│
  666889 ┤│
  333444 ┤│
       0 ┼╯──────────────────────────────────────────────────────────────────────────────
                                       write_bytes_per_second
initial store values: [s1=0, s2=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=0, s2=5001666] (stddev=2500833.00, mean=2500833.00, sum=5001666)

plot stat=replicas  
----
 15.00 ┤╭──────────────────────────────────────────────────────────────────────────────
 14.33 ┤│
 13.67 ┤│
 13.00 ┤│
 12.33 ┤│
 11.67 ┤│
 11.00 ┤│
 10.33 ┤│
  9.67 ┼╯
  9.00 ┤│
  8.33 ┤│
  7.67 ┤│
  7.00 ┤│
  6.33 ┤│
  5.67 ┤│
  5.00 ┤╰──────────────────────────────────────────────────────────────────────────────
                                            replicas
initial store values: [s1=10, s2=10] (stddev=0.00, mean=10.00, sum=20)
last store values: [s1=5, s2=15] (stddev=5.00, mean=10.00, sum=20)

plot stat=leases sample=1  
----
 15.00 ┤╭──────────────────────────────────────────────────────────────────────────────
 14.33 ┤│
 13.67 ┤│
 13.00 ┤│
 12.33 ┤│
 11.67 ┤│
 11.00 ┤│
 10.33 ┤│
  9.67 ┼╯
  9.00 ┤│
  8.33 ┤│
  7.67 ┤│
  7.00 ┤│
  6.33 ┤│
  5.67 ┤│
  5.00 ┤╰──────────────────────────────────────────────────────────────────────────────
                                             leases
initial store values: [s1=10, s2=10] (stddev=0.00, mean=10.00, sum=20)
last store values: [s1=5, s2=15] (stddev=5.00, mean=10.00, sum=20)
