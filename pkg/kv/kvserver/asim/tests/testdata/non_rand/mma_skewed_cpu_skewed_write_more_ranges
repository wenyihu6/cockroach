# This test can now roughly equalize both cpu and write bandwidth. It didn't
# use to be able to do this, because the highest cpu node had the lowest write
# bandwidth and vice versa, so neither was able to shed to the other. The
# ignoreLevel logic in rebalanceStores with the grace duration to start
# shedding more aggressively and other related changes have made this much
# better.

gen_cluster nodes=6 node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 26 MiB.
gen_ranges ranges=300 min_key=1 max_key=10000 placement_type=replica_placement bytes=26843545
{s1,s2,s3}:1
----
{s1:*,s2,s3}:1

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates little CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace.
gen_ranges ranges=300 min_key=10001 max_key=20000 placement_type=replica_placement bytes=26843545
{s4,s5,s6}:1
----
{s4:*,s5,s6}:1

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 raft_cpu_per_write=1 min_key=10001 max_key=20000
----

setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

eval duration=90m samples=1 seed=42
----
OK

plot stat=cpu sample=1  
----
 98306 ┤╭─────╮
 91753 ┤│     ╰──╮
 85199 ┤│        ╰──╮
 78645 ┤│           ╰──╮
 72091 ┤│              ╰─╮
 65538 ┤│                ╰╮
 58984 ┤│                 ╰─╮
 52430 ┤│                   ╰╮
 45876 ┤│                    ╰─╮
 39323 ┤│                      ╰─╮
 32769 ┤│                    ╭──────╮────╮─╮
 26215 ┤│            ╭─╮  ╭──╭─────────────────────────────────────────────────────────
 19661 ┤╭────────────╯╮╰─────╯───────────╯
 13108 ┤│            ╰╰─────╯
  6554 ┤│    ╭───────╯
     0 ┼╯────╯──╯
                                              cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=29310, s2=29007, s3=29244, s4=24167, s5=24500, s6=23834] (stddev=2519.03, mean=26677.00, sum=160062)

plot stat=write_bytes_per_second
----
 19995157 ┤╭──────────────╮
 18662147 ┤│  ╰╰────╮     ╰╮
 17329136 ┤│       ╰╰──╮   ╰───────╮
 15996126 ┤│          ╰╰╮          ╰─────────╮
 14663115 ┤│           ╰╰╮                   ╰─────────╮
 13330105 ┤│            ╰│                             ╰─────────╮
 11997094 ┤│             ╰╮                                      ╰─────────╮
 10664084 ┤│             ╰╰────────────────────────────────────────────────╰──────────────
  9331073 ┤│              ╭╯
  7998063 ┤│             ╭╯
  6665052 ┤│            ╭│                                                  ╭─────────────
  5332042 ┤│            ╭╯                                        ╭─────────╯
  3999031 ┤│           ╭╯                               ╭─────────╯
  2666021 ┤│        ╭──╯                      ╭─────────╯
  1333010 ┤│   ╭────╯                ╭────────╯
        0 ┼╯───╯─────────────────────╯
                                        write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=6204926, s2=10496506, s3=10429026, s4=10963242, s5=10962179, s6=10958400] (stddev=1712954.97, mean=10002379.83, sum=60014279)

plot stat=replicas  
----
 457 ┤               ╭───────────────────────────────────────────────────────────────
 438 ┤              ╭│
 420 ┤              ╭╯
 401 ┤             ╭│
 382 ┤            ╭╭╯
 364 ┤           ╭╭╯
 345 ┤         ╭──╯
 326 ┤    ╭────╯ ╭───╮
 308 ┼───────────╯   │
 289 ┤     ╰╰────╮─╮ ╰───────────╮                            ╭──────────────────────
 270 ┤          ╰╰─╮──────╮      ╰───────────╮    ╭───────────╯
 252 ┤            │╰╮     ╰──────────────────╰─────────╮
 233 ┤            ╰╮│                                  ╰───────────╮
 214 ┤             ╰╰╮             ╭───────────────────────────────╰─────────────────
 196 ┤              ╰│╭────────────╯╯
 177 ┤               ╰╯
                                          replicas
initial store values: [s1=300, s2=300, s3=300, s4=300, s5=300, s6=300] (stddev=0.00, mean=300.00, sum=1800)
last store values: [s1=287, s2=449, s3=449, s4=203, s5=207, s6=205] (stddev=109.28, mean=300.00, sum=1800)

plot stat=leases sample=1  
----
 300 ┼─────╮
 280 ┤     ╰────╮
 260 ┤         ╰╰─╮
 240 ┤            ╰╮─╮
 220 ┤             │ ╰─╮
 200 ┤             ╰╮  ╰╮       ╭────────────────────────────────────────────────────
 180 ┤              ╰───────────╯
 160 ┤                    ╰╮
 140 ┤                     ╰─╮ ╭╮  ╭────────────────╮
 120 ┤                    ╭╭╮──╯╰──│                ╰────────────────────────────────
 100 ┤               ╭╭────╯│  ╰───│──────────────────────╯
  80 ┤             ╭╭─╯     ╭──────╯
  60 ┤            ╭─╯       │──────────────────────╭─────────────────────────────────
  40 ┤          ╭─╯         │   ╭──────────────────╯
  20 ┤     ╭────╯  ╭────────╯───╯
   0 ┼─────────────╯
                                           leases
initial store values: [s1=300, s2=0, s3=0, s4=300, s5=0, s6=0] (stddev=141.42, mean=100.00, sum=600)
last store values: [s1=118, s2=58, s3=57, s4=200, s5=50, s6=117] (stddev=52.80, mean=100.00, sum=600)
