# This is identical to mma_high_write_uniform_cpu_all_enabled, but with
# the split/lease/replicate queues enable along with the mma store rebalancer.
gen_cluster nodes=10 node_cpu_rate_capacity=30000
----

# Read only workload, which generates 100_000 request cpu nanos/s evenly over
# the first half of the keyspace, which will be on all stores initially.
gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=even
----

gen_load rate=1000 rw_ratio=1 request_cpu_per_access=100 min_key=1 max_key=10000
----

setting rebalance_mode=3
----

# Write only workload, which generates no CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace, which
# are all on s1-s3 initially.
gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=skewed
----

gen_load rate=20000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

eval duration=20m samples=1 seed=42
----
OK

plot stat=cpu
----
 19984 ┤    ╭───╮
 18652 ┤    │   │                                                                 ╭╮
 17320 ┤    │   │  ╭╮                         ╭╮╭╮            ╭─╮     ╭╮          │╰╮
 15987 ┤    │   ╭──╮│                        ╭╯╰╯│            │ │     ││   ╭╮ ╭╮  │ │
 14655 ┤    │   │  ││                        │   │            │ │     ││   ││ ││  │ │
 13323 ┤╭╭──────│  ╰╭───╮╮╭─╮╮╭──╮        ╭─╮╯──╮╰───╮      ╭──╮╭──╮╭─╯│─╮╭╯╰─│╭──╯─╰─╮
 11990 ┤││││││ ││   │   │││ │││  │        │││   │    │      │ │╰╯  ││ │││││   ││││││ ││
 10658 ┤╭─╮╰─╯ │╭───╯╭╮ │╰╭╮╰╮╭╮─│───╭╮───────────────────╭─╯──────╰──────╭───╮│─││─╭││
  9326 ┤│╰╰─╮  ╰│────╯╰─╰╭╯╰──╯╰──────────────────────────────────────╮│╰││││╮╰╯─╰╯─│╰╰
  7994 ┤││  │   │   │  ││││ │    │       │ ││    ╭╯  │     │  │╰╮ │ ││││ ││││╰╮││ │││││
  6661 ┤│╰──│───╯───╰──╮╭╯──╯────╯       ╰─│╭╮──╭────╯     ╰──╰─╰╮╯ │╰╰───╯─╯───────╯─╰
  5329 ┤││  │   │      ││                  │││  │             │ │╰╮ │ ││      │  │
  3997 ┤│╰╮ ╰──────╮╭─╮╰│                  ││╰──╯             ╰─╯ ╰─╯ ╰╯      │  │
  2665 ┤│ │ │╰──╯  ╰╯ ╰─╯                  ╰╯                                 ╰╮ │
  1332 ┤│ │ │                                                                  │ │
     0 ┼╯ ╰─╯                                                                  ╰─╯
                                              cpu
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=13344, s2=10031, s3=9989, s4=10123, s5=6656, s6=9882, s7=10016, s8=9931, s9=6691, s10=9918] (stddev=1794.08, mean=9658.10, sum=96581)

plot stat=write_bytes_per_second
----
 18679331 ┤╭╮
 17434043 ┤││
 16188754 ┤╭╮
 14943465 ┤││╮
 13698176 ┤│││
 12452888 ┤│╰╮─╮
 11207599 ┤│ │ │╭──────╮
  9962310 ┤│ │╭╮│      │
  8717021 ┤│ ╰╯│╯      │    ╭──╮                ╭╮
  7471733 ┤│   ╭╭──────╮╮╭╮╭╯│ │╭╮╮          ╭╮╭││ ╭─╮         ╭─╮ ╭╮╮╮╭╭╮╮╭╮ ╭╮╭╮╮╭╮─╮╭╮╭
  6226444 ┤│   ╭╯──────│╭───╮╭──────╮╭──────────────────────────╮╭──────────╮╭╮─╭╮─│╰╮╭───
  4981155 ┤│ ╭╭╯╭──────╰╯││─╰╯──╰───╰╯───────╯╰╮│╰╯╭─────────╯╰╯╰╯╯╰╯╰╰╯╰╮╭─╰╯╰─╯╰╮│─││╰╯╰
  3735866 ┤│╭╭╯╰╯──────╯╰╰╯ ╰╯ ╰╯              ╰╯│╰╯           ╰─╯       ╰╯       ╰╯ ╰╯╰╯╰
  2490578 ┤╭╭╯──╯──────╯                        ╰╯
  1245289 ┤╭╯╯
        0 ┼╯
                                        write_bytes_per_second
initial store values: [s1=0, s2=0, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=0, s10=0] (stddev=0.00, mean=0.00, sum=0)
last store values: [s1=6341295, s2=6334516, s3=7348593, s4=5995943, s5=5874845, s6=4134498, s7=5992873, s8=4993091, s9=6326908, s10=5660652] (stddev=817278.93, mean=5900321.40, sum=59003214)

plot stat=replicas
----
 39.00 ┼╮
 37.00 ┤│
 35.00 ┤│
 33.00 ┤│
 31.00 ┤│╮                                                        ╭╮╭╮╭╮╮  ╭╮╭╮╮╭╮    ╭
 29.00 ┤╰╮                                                    ╭╭╭╮╮╰│╭╮╮╭╮╭╮╭││╰││╭╭╮─╮
 27.00 ┤ │                                                    ╭╭───────╮│││││││╭││││╰──
 25.00 ┤ ╰╮                                                  ╭─╯╯╯╰─╯╰─╰╯││╰─╯│╯│╰─╯╰╯╰
 23.00 ┤ ╰│                               ╭╮                 │╰╯ │╰╯╰╰╯╯╰╰╯╯╰╰╰─╯  ╰╯╯╰
 21.00 ┤  │         ╭╮╭╮ ╭╮ ╭╮            ││╮                ││  ╰╯           ╰╯
 19.00 ┤  ╰─╭╭──────╮─╮╭────╮╭──────────╮╮││─╭╭╮╮─╭─────╮───╭│╯
 17.00 ┤  ╭─╮│──────│╭───╮╭───────────────────╯╰─────────────╯
 15.00 ┤ ╭╯ ╰╯      ╰╯╰╯╯╰╯─╰╯───╯──────╰╯╰╰─╯╰╯   ╰─╯      ╰╯
 13.00 ┤╭│╯
 11.00 ┤╭╯
  9.00 ┼╯
                                            replicas
initial store values: [s1=39, s2=39, s3=39, s4=9, s5=9, s6=9, s7=9, s8=9, s9=9, s10=9] (stddev=13.75, mean=18.00, sum=180)
last store values: [s1=28, s2=27, s3=32, s4=27, s5=28, s6=24, s7=28, s8=25, s9=27, s10=27] (stddev=2.00, mean=27.30, sum=273)

plot stat=leases
----
 33.00 ┼╮
 30.93 ┤╰╮
 28.87 ┤ │
 26.80 ┤ │
 24.73 ┤ ╰╮
 22.67 ┤  │
 20.60 ┤  │
 18.53 ┤  ╰╮
 16.47 ┤   │
 14.40 ┤   │                                                    ╭─╭─╮─╭╮     ╭╮  ╭╮╭─╮╭
 12.33 ┤   ╰╮                                                ╭─────╮───────────────────
 10.27 ┤    │  ╭────╮╭╮ ╭╮                         ╭───────╮ │╯─╯ ╰╰──────╮─╭──╮╭╮╭─╮──
  8.20 ┤  ╭─╮╭──────╮╯╰─╯╰──────────────╭──╮────╭──╮─╭───────╭─────────╮╮ ╭╮╯╭╮╭╯╰╯─╰──
  6.13 ┤ ╭╯─╰╯──╭───╰───────────────────╯╭╭╰─────────────────╯─╭─────╭╮╰──╯╰─╯╰╯╭╰╯╮│╰─
  4.07 ┤╭╯╭─────────╯─╰╯╰─╯─╰─╯──╰────────╯╰╯─╰╯─────────────────────╯╰─╯╯ ╰──────╯╰╯──
  2.00 ┼╯─╯╯         ╰╯  ╰╯   ╰╯
                                             leases
initial store values: [s1=33, s2=3, s3=3, s4=3, s5=3, s6=3, s7=3, s8=3, s9=3, s10=3] (stddev=9.00, mean=6.00, sum=60)
last store values: [s1=15, s2=11, s3=8, s4=11, s5=6, s6=5, s7=13, s8=8, s9=6, s10=8] (stddev=3.11, mean=9.10, sum=91)
