# This test is designed to repro
# https://docs.google.com/document/d/1F35E9pOhtMlGAhKeidTyxRPaOpD3oP3DmT3cVvqVbhE/edit?tab=t.0.
# I'm not positive whether we support '+node1' as a key in constraints for data
# driven tests, so this is a workaround.
gen_cluster nodes=6 locality=(a,b,c,d,e,f) nodes_per_region=(1,1,1,1,1,1) node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# cpu.
gen_ranges ranges=1000 min_block=4096 max_block=8192 min_key=1 max_key=10000 placement_type=replica_placement bytes=26843545
{s1,s2,s3}:1
----
{s1,s2,s3}:1

set_span_config
[1,10000): num_replicas=3 num_voters=3 constraints={'+region=a':1,'+region=b':1,'+region=c':1}
----

gen_load rate=1000 rw_ratio=0.05 request_cpu_per_access=100 min_key=1 max_key=10000
----

# Write only workload, which generates little CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace.
gen_ranges ranges=1000 min_key=10001 max_key=20000 placement_type=replica_placement bytes=26843545 add_to_existing=true
{s4,s5,s6}:1
----
{s4,s5,s6}:1

set_span_config
[10001,20000): num_replicas=3 num_voters=3 constraints={'+region=d':1,'+region=e':1,'+region=f':1}
----

set_span_config delay=10m
[0,9999999999): num_replicas=3 num_voters=3
----

gen_load rate=20000 rw_ratio=0.8 min_block=1000 max_block=1000 raft_cpu_per_write=1 min_key=10001 max_key=20000 add_to_existing=true
----

setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

eval duration=60m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true show_initial_value=true
----
----

 99999 ┤╭───────────────╮
 93332 ┤│               ╰───────────╮
 86666 ┤│                           ╰────────╮
 79999 ┤│                                    ╰─────╮
 73333 ┤│                                          ╰───╮
 66666 ┤│                                              ╰───╮
 59999 ┤│                                                  ╰─╮
 53333 ┤│                                                    ╰──╮
 46666 ┤│                                                       ╰─╮╭╮
 40000 ┤│                                                         ╰╯╰─╮
 33333 ┤│                                                             ╰────────────────
 26666 ┤│                                                       ╭──────────────────────
 20000 ┤│                                                  ╭────╯───╯
 13333 ┤│                                          ╭───────╯
  6667 ┤╭──────────────────────────────────────────────────────────────────────────────
     0 ┼╯───────────────────────────╯
                                              cpu

initial store values: [s1=0 s2=0 s3=0 s4=0 s5=0 s6=0] (mean=0.00, stddev=0.00)
last store values: [s1=30574 s2=25596 s3=27325 s4=9246 s5=8810 s6=9854] (mean=18567.50, stddev=9383.26)
----
----

plot stat=write_bytes_per_second show_last_value=true show_initial_value=true
----
----

 4000000 ┤╭─────────────────────────────────────────────────╮
 3733333 ┤│                           ╰╰───────╮            ╰──╮
 3466667 ┤│                                   ╰╰───╮           ╰─────────────────────────
 3200000 ┤│                                     ╰──╰╮
 2933333 ┤│                                        ╰╰╮
 2666667 ┤│                                          ╰──╮
 2400000 ┤│                                            ╰╰─╮
 2133333 ┤│                                              ╰╰──────────────────────────────
 1866667 ┤│                                              ╭╭──╯
 1600000 ┤│                                            ╭──╯
 1333333 ┤│                                          ╭─╯
 1066667 ┤│                                        ╭╭╯
  800000 ┤│                                      ╭──╯
  533333 ┤│                                   ╭╭─╯
  266667 ┤│                           ╭────────╯
       0 ┼╯───────────────────────────╯──────────────────────────────────────────────────
                                       write_bytes_per_second

initial store values: [s1=0 s2=0 s3=0 s4=0 s5=0 s6=0] (mean=0.00, stddev=0.00)
last store values: [s1=74075 s2=2099022 s3=2099066 s4=2102947 s5=2101870 s6=3524763] (mean=2000290.50, stddev=1006204.40)
----
----

plot stat=replicas show_last_value=true show_initial_value=true
----
----

 1525 ┤                                                    ╭───────────────╮
 1460 ┤                                                ╭───╯╯              ╰──────────
 1396 ┤                                              ╭─╯
 1331 ┤                                            ╭─╯
 1266 ┤                                          ╭─╯
 1202 ┤                                         ╭╯
 1137 ┤                                      ╭──╯
 1072 ┤                                 ╭────╯
 1008 ┤              ╭───────────────────────────────────╮
  943 ┼──────────────╯────────────────────╮───────╮      ╰─╮                     ╭────
  878 ┤                                 ╰╯╰────╮  ╰────────╰─────────────────────╯────
  814 ┤                                      ╰─╰─╮
  749 ┤                                        ╰─╰╮
  684 ┤                                          ╰╰─╮
  620 ┤                                            ╰╰─╮
  555 ┤                                              ╰╰───────────────────────────────
                                           replicas

initial store values: [s1=1001 s2=1001 s3=1001 s4=1001 s5=1001 s6=1001] (mean=1001.00, stddev=0.00)
last store values: [s1=875 s2=1495 s3=1498 s4=599 s5=594 s6=945] (mean=1001.00, stddev=373.57)
----
----

plot stat=leases sample=1 show_last_value=true show_initial_value=true
----
----

 1001 ┼─────────────────────────────╮
  934 ┤                 ╰──────────╮╰───────╮
  868 ┤                            ╰────────╰─╮
  801 ┤                                     ╰─╰─╮─╮
  734 ┤                                         ╰──╮───╮
  667 ┤                                            ╰─╮ ╰──╮
  601 ┤                                              ╰─╮  ╰─╮           ╭─────────────
  534 ┤                                                ╰────────────────╯╮──────╮
  467 ┤                                                       ╭╭──────╯  ╰────────────
  400 ┤                                                 ╭─╭────╯   ╰─╮
  334 ┤                                              ╭────╯          ╰────────────────
  267 ┤                                           ╭──╯
  200 ┤                                       ╭╭──╯
  133 ┤                                   ╭────╯
   67 ┤                        ╭──────────╯                      ╭───────╭────────────
    0 ┼──────────────────────────────────────────────────────────────────╯
                                            leases

initial store values: [s1=1001 s2=0 s3=0 s4=1001 s5=0 s6=0] (mean=333.67, stddev=471.88)
last store values: [s1=312 s2=488 s3=478 s4=595 s5=67 s6=62] (mean=333.67, stddev=207.50)
----
----
