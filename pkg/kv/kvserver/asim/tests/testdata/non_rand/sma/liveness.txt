# This test verifies node liveness handling in a 7-node cluster with 700 ranges (RF=3).
# Node 7 is dead initially, node 6 becomes decommissioning after 3 minutes.
# Expected: Dead/decommissioning nodes lose all replicas and leases.
skip_under_ci
----

# This example sets n7 to dead initially and n5 to decommissioning after 2
# minutes.
#
# Create 7 stores, with 700 ranges (RF=3). Each store should have approx 300
# replicas and 100 leases.
gen_cluster nodes=7
----

gen_ranges ranges=700
----

# n7 is dead and remains dead forever. It will still have its initial (3000)
# replicas.
set_liveness node=7 liveness=dead
----

# n6 becomes decommissioning after 3 minutes and remains decommissioning
# thereafter.
set_liveness node=6 liveness=decommissioning delay=3m
----

# The number of replicas on the dead and decommissioning stores should be 0,
# assert this.
assertion type=stat stat=replicas ticks=6 exact_bound=0 stores=(6,7)
----

# We expect one node(store) (n7) to immediately start losing replicas, whilst
# other stores gain replicas evenly. After 3 minutes, we expect another
# node(store) (n6) to begin losing replicas in a similar manner.
# Both nodes should begin losing leases immediately after their liveness status
# is changed to dead or decommissioning (5 minutes later).
eval duration=12m seed=42 metrics=(replicas,leases) cfgs=(sma-count,mma-only)
----
leases#1: first: [s1=100, s2=100, s3=100, s4=100, s5=100, s6=100, s7=100] (stddev=0.00, mean=100.00, sum=700)
leases#1: last:  [s1=122, s2=121, s3=128, s4=120, s5=124, s6=85, s7=0] (stddev=42.95, mean=100.00, sum=700)
leases#1: thrash_pct: [s1=4%, s2=0%, s3=2%, s4=0%, s5=0%, s6=25%, s7=0%]  (sum=32%)
replicas#1: first: [s1=300, s2=300, s3=300, s4=300, s5=300, s6=300, s7=300] (stddev=0.00, mean=300.00, sum=2100)
replicas#1: last:  [s1=381, s2=380, s3=388, s4=375, s5=388, s6=188, s7=0] (stddev=139.70, mean=300.00, sum=2100)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=19%, s7=0%]  (sum=19%)
artifacts[sma-count]: fa51c2e21d82f7ed
failed assertion sample 1
  stat=replicas value=(=0.00) ticks=6
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
==========================
leases#1: first: [s1=100, s2=100, s3=100, s4=100, s5=100, s6=100, s7=100] (stddev=0.00, mean=100.00, sum=700)
leases#1: last:  [s1=124, s2=119, s3=129, s4=120, s5=123, s6=85, s7=0] (stddev=42.98, mean=100.00, sum=700)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=25%, s7=0%]  (sum=25%)
replicas#1: first: [s1=300, s2=300, s3=300, s4=300, s5=300, s6=300, s7=300] (stddev=0.00, mean=300.00, sum=2100)
replicas#1: last:  [s1=381, s2=380, s3=388, s4=375, s5=388, s6=188, s7=0] (stddev=139.70, mean=300.00, sum=2100)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=19%, s7=0%]  (sum=19%)
artifacts[mma-only]: fe242ac6ff72bc9d
failed assertion sample 1
  stat=replicas value=(=0.00) ticks=6
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
	store=6 stat=188.00
==========================
