# This test sets up a multi-store cluster.  We assert on this with a balance
# threshold of 1 (i.e. identical number of leases) and a steady state threshold
# of 0 (i.e. doesn't change). mma-only fails because it doesn't balance based on
# lease.
gen_cluster nodes=7 stores_per_node=2
----

gen_ranges ranges=14 placement_type=skewed
----

gen_load rate=7000 min_block=512 max_block=512
----
3.4 MiB/s goodput

assertion stat=leases type=balance ticks=6 upper_bound=1
----
asserting: max_{stores}(leases)/mean_{stores}(leases) ≤ 1.00 at each of last 6 ticks

assertion stat=leases type=steady ticks=6 exact_bound=0
----
asserting: |leases(t)/mean_{T}(leases) - 1| = 0.00 ∀ t∈T and each store (T=last 6 ticks)

# Assertion failed here since we don't balance based on lease.
eval duration=5m seed=42 metrics=(leases) cfgs=(sma-count,mma-only)
----
leases#1: first: [s1=8, s2=3, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=1, s10=0, s11=1, s12=0, s13=1, s14=0] (stddev=2.10, mean=1.00, sum=14)
leases#1: last:  [s1=1, s2=1, s3=1, s4=1, s5=1, s6=1, s7=1, s8=1, s9=1, s10=1, s11=1, s12=1, s13=1, s14=1] (stddev=0.00, mean=1.00, sum=14)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=25%, s9=50%, s10=0%, s11=0%, s12=0%, s13=50%, s14=50%]  (sum=175%)
artifacts[sma-count]: c2c4c33405e760ae
==========================
leases#1: first: [s1=8, s2=3, s3=0, s4=0, s5=0, s6=0, s7=0, s8=0, s9=1, s10=0, s11=1, s12=0, s13=1, s14=0] (stddev=2.10, mean=1.00, sum=14)
leases#1: last:  [s1=2, s2=1, s3=0, s4=0, s5=0, s6=2, s7=1, s8=1, s9=2, s10=0, s11=2, s12=1, s13=2, s14=0] (stddev=0.85, mean=1.00, sum=14)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%, s6=0%, s7=0%, s8=0%, s9=0%, s10=0%, s11=27%, s12=0%, s13=0%, s14=0%]  (sum=27%)
artifacts[mma-only]: 3c0367979362c91f
failed assertion sample 1
  balance stat=leases threshold=(≤1.00) ticks=6
	max/mean=2.00 tick=0
	max/mean=2.00 tick=1
	max/mean=2.00 tick=2
	max/mean=2.00 tick=3
	max/mean=2.00 tick=4
	max/mean=2.00 tick=5
==========================
