# 16vCPU machines.
gen_cluster nodes=10 node_cpu_rate_capacity=16000000000
----

# 30 ranges on first fives nodes, 30 ranges on the last five nodes.

gen_ranges ranges=30 min_key=1 max_key=10000 placement_type=replica_placement
{s1,s2,s3}:1
{s2,s3,s4}:1
{s3,s4,s5}:1
{s4,s5,s1}:1
{s5,s1,s2}:1
----
{s1:*,s2,s3}:1
{s2:*,s3,s4}:1
{s3:*,s4,s5}:1
{s4:*,s5,s1}:1
{s5:*,s1,s2}:1

gen_ranges ranges=30 min_key=10001 max_key=20000 placement_type=replica_placement
{s6,s7,s8}:1
{s7,s8,s9}:1
{s8,s9,s10}:1
{s9,s10,s6}:1
{s10,s6,s7}:1
----
{s6:*,s7,s8}:1
{s7:*,s8,s9}:1
{s8:*,s9,s10}:1
{s9:*,s10,s6}:1
{s10:*,s6,s7}:1

# Read-only workload on first 30 ranges. 5 cores.
gen_load rate=1000000 rw_ratio=1 request_cpu_per_access=5000 min_key=1 max_key=10000
----

# Write only workload on second 30 ranges. 10mb/s before 3x replication.
gen_load rate=10000 rw_ratio=0 min_block=1000 max_block=1000 min_key=10001 max_key=20000
----

# Two minutes into the test, we'll enable the MMA.
setting rebalance_mode=4 delay=2m
----

eval duration=7m samples=1 seed=42 cfgs=(sma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=490113941, s2=401918412, s3=487479869, s4=516887727, s5=429101108, s6=510046555, s7=546044811, s8=513566533, s9=574520521, s10=527149351] (stddev=48868018.52, mean=499682882.80, sum=4996828828)
cpu#1: thrash_pct: [s1=24%, s2=21%, s3=43%, s4=29%, s5=15%, s6=12%, s7=30%, s8=2%, s9=10%, s10=17%]  (sum=203%)
cpu_util#1: last:  [s1=0.03, s2=0.03, s3=0.03, s4=0.03, s5=0.03, s6=0.03, s7=0.03, s8=0.03, s9=0.04, s10=0.03] (stddev=0.00, mean=0.03, sum=0)
cpu_util#1: thrash_pct: [s1=24%, s2=21%, s3=43%, s4=29%, s5=15%, s6=12%, s7=30%, s8=2%, s9=10%, s10=17%]  (sum=203%)
leases#1: first: [s1=6, s2=6, s3=6, s4=6, s5=6, s6=6, s7=6, s8=6, s9=6, s10=6] (stddev=0.00, mean=6.00, sum=60)
leases#1: last:  [s1=54, s2=53, s3=56, s4=59, s5=54, s6=57, s7=61, s8=59, s9=61, s10=57] (stddev=2.74, mean=57.10, sum=571)
leases#1: thrash_pct: [s1=104%, s2=112%, s3=104%, s4=93%, s5=131%, s6=30%, s7=54%, s8=18%, s9=33%, s10=36%]  (sum=714%)
replicas#1: first: [s1=18, s2=18, s3=18, s4=18, s5=18, s6=18, s7=18, s8=18, s9=18, s10=18] (stddev=0.00, mean=18.00, sum=180)
replicas#1: last:  [s1=175, s2=171, s3=172, s4=176, s5=174, s6=168, s7=167, s8=167, s9=177, s10=166] (stddev=3.90, mean=171.30, sum=1713)
replicas#1: thrash_pct: [s1=88%, s2=97%, s3=102%, s4=94%, s5=103%, s6=27%, s7=22%, s8=17%, s9=20%, s10=12%]  (sum=582%)
write_bytes_per_second#1: last:  [s1=3004673, s2=2988871, s3=3009953, s4=2654588, s5=2999311, s6=3323750, s7=2993873, s8=2989535, s9=2983259, s10=3008428] (stddev=149891.83, mean=2995624.10, sum=29956241)
write_bytes_per_second#1: thrash_pct: [s1=134%, s2=83%, s3=172%, s4=171%, s5=173%, s6=255%, s7=332%, s8=167%, s9=240%, s10=193%]  (sum=1921%)
artifacts[sma-count]: abd5a26eea519297
==========================
