# This test can now roughly equalize both cpu and write bandwidth. It didn't
# use to be able to do this, because the highest cpu node had the lowest write
# bandwidth and vice versa, so neither was able to shed to the other. The
# ignoreLevel logic in rebalanceStores with the grace duration to start
# shedding more aggressively and other related changes have made this much
# better.
gen_cluster nodes=6 locality=(a,b) nodes_per_region=(3,3) node_cpu_rate_capacity=50000
----

# The placement will be skewed, s.t. n1/s1, n2/s2 and n3/s3 will have all the
# replicas initially and n1/s1 will have every lease. Each range is initially
# 26 MiB.
gen_ranges ranges=300 min_key=1 max_key=10000 placement_type=replica_placement bytes=26843545
{s1,s2,s3}:1
----
{s1,s2,s3}:1

set_span_config
[1,10000): num_replicas=3 num_voters=3 constraints={'+region=a':3}]
----

gen_load rate=200 rw_ratio=0.05 request_cpu_per_access=100 min_key=1 max_key=10000 min_block=1000 max_block=1000
----

# Write only workload, which generates little CPU and 100_000 (x replication
# factor) write bytes per second over the second half of the keyspace.
gen_ranges ranges=300 min_key=10001 max_key=20000 placement_type=replica_placement bytes=26843545 add_to_existing=true
{s4,s5,s6}:1
----
{s4,s5,s6}:1

set_span_config
[10001,20000): num_replicas=3 num_voters=3 constraints={'+region=b':3}]
----

gen_load rate=20000 rw_ratio=0.8 min_block=1000 max_block=1000 min_key=10001 max_key=20000 add_to_existing=true
----

setting rebalance_mode=3 replicate_queue_enabled=false lease_queue_enabled=false split_queue_enabled=false
----

set_span_config delay=5m
[0,9999999999): num_replicas=3 num_voters=3
----

eval duration=60m samples=1 seed=42
----
OK

plot stat=cpu sample=1  show_last_value=true show_initial_value=true
----
----

 20000 ┤╭────╮
 18667 ┤│    ╰────────╮
 17333 ┤│             ╰──────╮
 16000 ┤│                    ╰─────╮
 14667 ┤│                          ╰───╮
 13333 ┤│                              ╰───╮
 12000 ┤│                                  ╰───╮
 10667 ┤│                                      ╰──╮
  9333 ┤│                                         ╰──╮
  8000 ┤│                                            ╰──╮
  6667 ┤│                                               ╰──╮
  5333 ┤│                                             ╭───────╮──╮
  4000 ┤│                                   ╭─────────╯───────╰────────────────────────
  2667 ┤│                       ╭───────────╯──╯               ╭╭──────────────────────
  1333 ┤│         ╭─────────────╯────╯╰╯         ╭╮─╭╭──────────╯
     0 ┼─────────────────────────────────────────────╯
                                              cpu

initial store values: [s1=0 s2=0 s3=0 s4=0 s5=0 s6=0] (mean=0.00, stddev=0.00)
last store values: [s1=3694 s2=3603 s3=3607 s4=2978 s5=3028 s6=2982] (mean=3315.33, stddev=321.11)
----
----

plot stat=write_bytes_per_second show_last_value=true show_initial_value=true
----
----

 4000000 ┤╭───────────────╮
 3733333 ┤│      ╰╯╰────╮ ╰─────────╮
 3466667 ┤│            ╰╰─╮         ╰────────╮
 3200000 ┤│               ╰──╮               ╰────────────╮
 2933333 ┤│                 ╰╰─╮                          ╰──────────────────╮
 2666667 ┤│                  ╰╮│                                             ╰─────────╮
 2400000 ┤│                   │╰╮                                                      ╰─
 2133333 ┤│                   ╰─╰────────────────────────────────────────────────────────
 1866667 ┤│                    ╭╯
 1600000 ┤│                   ╭│                                                 ╭───────
 1333333 ┤│                  ╭─╯                                         ╭───────╯
 1066667 ┤│                ╭─╯                     ╭─────────────────────╯
  800000 ┤│             ╭──╯             ╭─────────╯
  533333 ┤│         ╭───╯      ╭─────────╯
  266667 ┤│─────────╯──────────╯
       0 ┼╯
                                       write_bytes_per_second

initial store values: [s1=0 s2=0 s3=0 s4=0 s5=0 s6=0] (mean=0.00, stddev=0.00)
last store values: [s1=1671825 s2=2109684 s3=2106654 s4=2101612 s5=2101803 s6=2479653] (mean=2095205.17, stddev=233622.27)
----
----

plot stat=replicas show_last_value=true  show_initial_value=true
----
----

 443 ┤                     ╭╭──────────────────────╮─╮
 424 ┤                     ╭╯                      ╰──────────╮
 406 ┤                    ╭│                                  ╰──────────────────────
 387 ┤                   ╭╭╯
 368 ┤                  ╭╭╯
 350 ┤                ╭╭─╯                                                          ╭
 331 ┤             ╭───╯                 ╭─────────────────╮              ╭─────────╯
 312 ┤         ╭───╯       ╭─────────────╯                 ╰──────────────╯
 294 ┼─────────────────────╮
 275 ┤          ╰╰──╮      ╰───────╮
 256 ┤             ╰╰──╮           ╰──────────╮          ╭──────────────────╮
 238 ┤                 ╰─╮                    ╰──────────╯                  ╰───────╮
 219 ┤                   ╰─╮                                                        ╰
 200 ┤                   ╰╮│                                   ╭─────────────────────
 182 ┤                    │╰╮                         ╭────────╯─╯
 163 ┤                    ╰─╰─────────────────────────╯─╯
                                          replicas

initial store values: [s1=301 s2=301 s3=301 s4=301 s5=301 s6=301] (mean=301.00, stddev=0.00)
last store values: [s1=348 s2=412 s3=410 s4=200 s5=204 s6=232] (mean=301.00, stddev=92.00)
----
----

plot stat=leases sample=1 show_last_value=true  show_initial_value=true
----
----

 301 ┼─────────╮
 281 ┤        ╰╰───╮──╮
 261 ┤             ╰───╮────╮
 241 ┤                 ╰─╮  ╰─────╮
 221 ┤                   │        ╰───╮
 201 ┤                   ╰╮           ╰───╮                    ╭─────────────────────
 181 ┤                    ╰╮              ╰───╮       ╭────────╯
 161 ┤                     ╰──────────────────────────╯
 140 ┤                                          ╭╭──────────────╮─╮
 120 ┤                                 ╭╭────────╯  ╰──╮        ╰────────────────────
 100 ┤                     ╭╭───────────╯              ╰──╮
  80 ┤                    ╭─╯                             ╰──────╮
  60 ┤                  ╭╭╯                                      ╰───────────────────
  40 ┤               ╭───╯                                   ╭╭──────────────────────
  20 ┤         ╭─────╯                           ╭─╭──────────╯
   0 ┼─────────────────────────────────────────────╯
                                           leases

initial store values: [s1=301 s2=0 s3=0 s4=301 s5=0 s6=0] (mean=100.33, stddev=141.89)
last store values: [s1=62 s2=130 s3=121 s4=198 s5=46 s6=45] (mean=100.33, stddev=55.27)
----
----
